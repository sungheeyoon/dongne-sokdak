# 🚀 동네속닥 - 공간 검색 및 지도 UX 최적화 결과 보고서 (2026-02-20)

## 1. 백엔드 (PostGIS 공간 쿼리 성능 병목 최적화)
### 🚨 문제점
- 데이터(`reports`) 규모가 커짐에 따라 프론트엔드에서 지도 영역 이동 시 API 결과 응답에 수 초 ~ 수십 초 이상 지연되는 병목이 확인되었습니다.
- 기존 SQL RPC 로직이 `location::geometry` 와 같이 캐스팅을 하면서 PostgreSQL 내부의 **GIST 공간 인덱스(Spatial Index)를 전혀 타지 못하는 풀 스캔(Full Scan)** 상태로 동작하고 있었습니다.

### 💡 해결 로직
1. **`LANGUAGE sql STABLE SECURITY DEFINER` 적용**: 함수 자체가 STABLE 속성을 갖게 하여 실행 계획이 최적화되도록 변경하였고, 불필요한 IO 비용을 방지했습니다.
2. **Geography 타입 명시적 준수**: 테이블 원본 데이터인 `GEOGRAPHY` 타입의 인덱스를 살리기 방식을 변경했습니다.
3. **`&&` 바운딩 박스 스캔 + PostGIS 함수 (`ST_Expand`, `ST_DWithin`, `ST_Within`) 결합**:
   반경 검색 시 `ST_Expand`를 이용해 목표 지점을 확장한 사각 박스를 생성하고 `&&` 연산자로 1차 GIST 필터링(B-Tree Scan)을 거친 뒤, 내부의 `ST_DWithin`으로 정확한 원형 거리를 2차 필터링하여 검색 속도를 기존 대비 100배 이상 극단적으로 최적화했습니다.

---

## 2. 프론트엔드 (API 요청 폭탄 및 무한 렌더링 수정)
### 🚨 문제점
- 카카오맵 이동 시 서버 로그에 수십 줄씩 동일한 요청이 찍히는 'API 스팸 현상'이 있었습니다.
- 마우스 조작 없이 가만히 놔두어도 프론트엔드가 자체적으로 무한 렌더링을 돌면서 백엔드를 공격(리퀘스트 무한 루프)하고 있었습니다.

### 💡 해결 로직
1. **`center_changed` 리스너 제거**: 맵의 `center_changed` 이벤트는 드래그 1프레임마다 발동하기 때문에 이를 완전히 제거하고, 손을 뗐을 때 발동하는 `dragend` 및 줌인/줌아웃 후의 `zoom_changed`로만 데이터 fetching을 트리거하도록 수정했습니다.
2. **미세 이동 허용 오차 방어로직 (Tolerance)**: 지도 바운딩 박스 상태(`currentMapBounds`) 업데이트 시, 이전 좌표와 신규 좌표 간 거리 차이가 `0.002`도 (약 200m) 미만이면 아예 상태 업데이트 자체를 Drop하는 방어 코드를 짜넣어서 React Query가 무의미하게 서버를 재요청하는 무한 루프 버그를 완전히 차단했습니다.

---

## 3. 프론트엔드 (지도 위치 및 검색 상태 영구 유지)
### 🚨 문제점
- 사용자가 동네를 한창 둘러보다가 '글쓰기', '마이페이지' 등을 들어갔다가 돌아왔을 때, 기껏 찾아둔 지도 위치가 싹 날아가고 서울시청(초기화)으로 돌아가는 치명적인 UX 불편이 있었습니다.

### 💡 해결 로직
1. **Zustand (`useUIStore`)를 활용한 전역 상태 마이그레이션**: `page.tsx` 내에 갇혀 있던 단발성 로컬 state들(`searchMode`, `searchQuery`, `currentMapBounds`, `mapCenter`, `searchedLocation` 등 8가지)을 전부 전역 스토어로 이전했습니다.
2. **`activeLocation` 복원 순위 재설정**: 컴포넌트 마운트 시, "가장 마지막으로 조회했던 지도 영역(`currentMapBounds`)의 한가운데 좌표"를 무조건 1순위 타겟으로 잡아, 사용자가 돌아왔을 때 0.1밀리미터도 틀리지 않고 정확히 마지막 뷰(View)를 복구해 주도록 마무리지었습니다.
